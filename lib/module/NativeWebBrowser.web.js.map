{"version":3,"sources":["NativeWebBrowser.web.ts"],"names":["compareUrls","AppState","Dimensions","Platform","WebBrowserResultType","isDOMAvailable","OS","POPUP_WIDTH","POPUP_HEIGHT","popupWindow","listenerMap","Map","getHandle","getOriginUrlHandle","hash","getRedirectUrlHandle","dismissPopup","close","has","listener","appStateListener","interval","get","clearInterval","window","removeEventListener","delete","handle","localStorage","getItem","removeItem","name","openBrowserAsync","url","browserParams","type","CANCEL","windowName","windowFeatures","features","getPopupFeaturesString","open","OPENED","dismissAuthSession","maybeCompleteAuthSession","skipRedirectCheck","message","location","href","redirectUrl","currentUrl","origin","pathname","setItem","parent","opener","Error","postMessage","expoSender","toString","openAuthSessionAsync","openOptions","getRedirectUrlFromUrlOrGenerate","state","getStateFromUrlOrGenerateAsync","closed","focus","Promise","resolve","event","isTrusted","data","addEventListener","setInterval","DISMISS","set","isCryptoAvailable","crypto","isSubtleCryptoAvailable","subtle","inputUrl","URL","searchParams","generateStateAsync","CHARSET","encoder","TextEncoder","generateRandom","buffer","encode","hashedData","digest","btoa","String","fromCharCode","Uint8Array","size","arr","byteLength","length","array","getRandomValues","i","Math","random","bufferToString","index","push","join","normalizePopupFeaturesString","options","windowFeaturePairs","split","pair","key","value","trim","width","height","dimensions","top","max","left","featureObjectToString","toolbar","menubar","resizable","status","scrollbars","Object","keys","reduce","prev","current"],"mappings":"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","sourcesContent":["import compareUrls from 'compare-urls';\nimport { AppState, Dimensions, AppStateStatus, Platform } from 'react-native';\n\nimport {\n  WebBrowserAuthSessionResult,\n  WebBrowserOpenOptions,\n  WebBrowserResult,\n  WebBrowserResultType,\n  WebBrowserWindowFeatures,\n} from './WebBrowser.types';\n\nconst isDOMAvailable = Platform.OS === 'web';\n\nconst POPUP_WIDTH = 500;\nconst POPUP_HEIGHT = 650;\n\nlet popupWindow: Window | null = null;\n\nconst listenerMap = new Map();\n\nconst getHandle = () => 'ExpoWebBrowserRedirectHandle';\nconst getOriginUrlHandle = (hash: string) => `ExpoWebBrowser_OriginUrl_${hash}`;\nconst getRedirectUrlHandle = (hash: string) =>\n  `ExpoWebBrowser_RedirectUrl_${hash}`;\n\nfunction dismissPopup() {\n  if (!popupWindow) {\n    return;\n  }\n  popupWindow.close();\n  if (listenerMap.has(popupWindow)) {\n    const { listener, appStateListener, interval } =\n      listenerMap.get(popupWindow);\n    clearInterval(interval);\n    window.removeEventListener('message', listener);\n    AppState.removeEventListener('change', appStateListener);\n    listenerMap.delete(popupWindow);\n\n    const handle = window.localStorage.getItem(getHandle());\n    if (handle) {\n      window.localStorage.removeItem(getHandle());\n      window.localStorage.removeItem(getOriginUrlHandle(handle));\n      window.localStorage.removeItem(getRedirectUrlHandle(handle));\n    }\n\n    popupWindow = null;\n  }\n}\n\nexport default {\n  get name() {\n    return 'ExpoWebBrowser';\n  },\n  async openBrowserAsync(\n    url: string,\n    browserParams: WebBrowserOpenOptions = {}\n  ): Promise<WebBrowserResult> {\n    if (!isDOMAvailable) return { type: WebBrowserResultType.CANCEL };\n    const { windowName = '_blank', windowFeatures } = browserParams;\n    const features = getPopupFeaturesString(windowFeatures);\n    window.open(url, windowName, features);\n    return { type: WebBrowserResultType.OPENED };\n  },\n  dismissAuthSession() {\n    if (!isDOMAvailable) return;\n    dismissPopup();\n  },\n  maybeCompleteAuthSession({\n    skipRedirectCheck,\n  }: {\n    skipRedirectCheck?: boolean;\n  }): {\n    type: 'success' | 'failed';\n    message: string;\n  } {\n    if (!isDOMAvailable) {\n      return {\n        type: 'failed',\n        message: 'Cannot use expo-web-browser in a non-browser environment',\n      };\n    }\n    const handle = window.localStorage.getItem(getHandle());\n\n    if (!handle) {\n      return {\n        type: 'failed',\n        message: 'No auth session is currently in progress',\n      };\n    }\n\n    const url = window.location.href;\n\n    if (skipRedirectCheck !== true) {\n      const redirectUrl = window.localStorage.getItem(\n        getRedirectUrlHandle(handle)\n      );\n      // Compare the original redirect url against the current url with it's query params removed.\n      const currentUrl = window.location.origin + window.location.pathname;\n      if (!compareUrls(redirectUrl, currentUrl)) {\n        return {\n          type: 'failed',\n          message: `Current URL \"${currentUrl}\" and original redirect URL \"${redirectUrl}\" do not match.`,\n        };\n      }\n    }\n\n    // Save the link for app state listener\n    window.localStorage.setItem(getOriginUrlHandle(handle), url);\n\n    // Get the window that created the current popup\n    const parent = window.opener ?? window.parent;\n    if (!parent) {\n      throw new Error(\n        \"ERR_WEB_BROWSER_REDIRECT: The window cannot complete the redirect request because the invoking window doesn't have a reference to it's parent. This can happen if the parent window was reloaded.\"\n      );\n    }\n    // Send the URL back to the opening window.\n    parent.postMessage({ url, expoSender: handle }, parent.location.toString());\n    return { type: 'success', message: `Attempting to complete auth` };\n\n    // Maybe set timer to throw an error if the window is still open after attempting to complete.\n  },\n  // This method should be invoked from user input.\n  async openAuthSessionAsync(\n    url: string,\n    redirectUrl?: string,\n    openOptions?: WebBrowserOpenOptions\n  ): Promise<WebBrowserAuthSessionResult> {\n    if (!isDOMAvailable) return { type: WebBrowserResultType.CANCEL };\n\n    redirectUrl = redirectUrl ?? getRedirectUrlFromUrlOrGenerate(url);\n\n    const state = await getStateFromUrlOrGenerateAsync(url);\n\n    // Save handle for session\n    window.localStorage.setItem(getHandle(), state);\n    // Save redirect Url for further verification\n    window.localStorage.setItem(getRedirectUrlHandle(state), redirectUrl);\n\n    if (popupWindow == null || popupWindow?.closed) {\n      const features = getPopupFeaturesString(openOptions?.windowFeatures);\n      popupWindow = window.open(url, openOptions?.windowName, features);\n\n      if (popupWindow) {\n        try {\n          popupWindow.focus();\n        } catch {}\n      } else {\n        throw new Error(\n          'ERR_WEB_BROWSER_BLOCKED: Popup window was blocked by the browser or failed to open. This can happen in mobile browsers when the window.open() method was invoked too long after a user input was fired.'\n        );\n      }\n    }\n\n    return new Promise(async (resolve) => {\n      // Create a listener for messages sent from the popup\n      const listener = (event: MessageEvent) => {\n        if (!event.isTrusted) return;\n        // Ensure we trust the sender.\n        if (event.origin !== window.location.origin) {\n          return;\n        }\n        const { data } = event;\n        // Use a crypto hash to invalid message.\n        const handle = window.localStorage.getItem(getHandle());\n        // Ensure the sender is also from expo-web-browser\n        if (data.expoSender === handle) {\n          dismissPopup();\n          resolve({ type: 'success', url: data.url });\n        }\n      };\n\n      // Add a listener for receiving messages from the popup.\n      window.addEventListener('message', listener, false);\n\n      // Create an app state listener as a fallback to the popup listener\n      const appStateListener = (state: AppStateStatus) => {\n        if (state !== 'active') {\n          return;\n        }\n        const handle = window.localStorage.getItem(getHandle());\n        if (handle) {\n          const url = window.localStorage.getItem(getOriginUrlHandle(handle));\n          if (url) {\n            dismissPopup();\n            resolve({ type: 'success', url });\n          }\n        }\n      };\n\n      AppState.addEventListener('change', appStateListener);\n\n      // Check if the window has been closed every second.\n      const interval = setInterval(() => {\n        if (popupWindow?.closed) {\n          if (resolve) resolve({ type: WebBrowserResultType.DISMISS });\n          clearInterval(interval);\n          dismissPopup();\n        }\n      }, 1000);\n\n      // Store the listener and interval for clean up.\n      listenerMap.set(popupWindow, {\n        listener,\n        interval,\n        appStateListener,\n      });\n    });\n  },\n};\n\n// Crypto\nfunction isCryptoAvailable(): boolean {\n  if (!isDOMAvailable) return false;\n  return !!(window?.crypto as any);\n}\n\nfunction isSubtleCryptoAvailable(): boolean {\n  if (!isCryptoAvailable()) return false;\n  return !!(window.crypto.subtle as any);\n}\n\nasync function getStateFromUrlOrGenerateAsync(\n  inputUrl: string\n): Promise<string> {\n  const url = new URL(inputUrl);\n  if (\n    url.searchParams.has('state') &&\n    typeof url.searchParams.get('state') === 'string'\n  ) {\n    // Ensure we reuse the auth state if it's passed in.\n    return url.searchParams.get('state')!;\n  }\n  // Generate a crypto state for verifying the return popup.\n  return await generateStateAsync();\n}\n\nfunction getRedirectUrlFromUrlOrGenerate(inputUrl: string): string {\n  const url = new URL(inputUrl);\n  if (\n    url.searchParams.has('redirect_uri') &&\n    typeof url.searchParams.get('redirect_uri') === 'string'\n  ) {\n    // Ensure we reuse the redirect_uri if it's passed in the input url.\n    return url.searchParams.get('redirect_uri')!;\n  }\n  // Emulate how native uses Constants.linkingUrl\n  return location.origin + location.pathname;\n}\n\nconst CHARSET =\n  'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n\nasync function generateStateAsync(): Promise<string> {\n  if (!isSubtleCryptoAvailable()) {\n    throw new Error(\n      \"ERR_WEB_BROWSER_CRYPTO: The current environment doesn't support crypto. Ensure you are running from a secure origin (https).\"\n    );\n  }\n  const encoder = new TextEncoder();\n\n  const data = generateRandom(10);\n  const buffer = encoder.encode(data);\n  const hashedData = await crypto.subtle.digest('SHA-256', buffer);\n  const state = btoa(String.fromCharCode(...new Uint8Array(hashedData)));\n  return state;\n}\n\nfunction generateRandom(size: number): string {\n  let arr = new Uint8Array(size);\n  if (arr.byteLength !== arr.length) {\n    arr = new Uint8Array(arr.buffer);\n  }\n  const array = new Uint8Array(arr.length);\n  if (isCryptoAvailable()) {\n    window.crypto.getRandomValues(array);\n  } else {\n    for (let i = 0; i < size; i += 1) {\n      array[i] = (Math.random() * CHARSET.length) | 0;\n    }\n  }\n  return bufferToString(array);\n}\n\nfunction bufferToString(buffer: Uint8Array): string {\n  const state: string[] = [];\n  for (let i = 0; i < buffer.byteLength; i += 1) {\n    const index = buffer[i] % CHARSET.length;\n    state.push(CHARSET[index]);\n  }\n  return state.join('');\n}\n\n// Window Features\n\n// Ensure feature string is an object\nfunction normalizePopupFeaturesString(\n  options?: WebBrowserWindowFeatures | string\n): Record<string, any> {\n  let windowFeatures: Record<string, any> = {};\n  // This should be avoided because it adds extra time to the popup command.\n  if (typeof options === 'string') {\n    // Convert string of `key=value,foo=bar` into an object\n    const windowFeaturePairs = options.split(',');\n    for (const pair of windowFeaturePairs) {\n      const [key, value] = pair.trim().split('=');\n      if (key && value) {\n        windowFeaturePairs[key as any] = value;\n      }\n    }\n  } else if (options) {\n    windowFeatures = options;\n  }\n  return windowFeatures;\n}\n\n// Apply default values to the input feature set\nfunction getPopupFeaturesString(\n  options?: WebBrowserWindowFeatures | string\n): string {\n  const windowFeatures = normalizePopupFeaturesString(options);\n\n  const width = windowFeatures.width ?? POPUP_WIDTH;\n  const height = windowFeatures.height ?? POPUP_HEIGHT;\n\n  const dimensions = Dimensions.get('screen');\n  const top =\n    windowFeatures.top ?? Math.max(0, (dimensions.height - height) * 0.5);\n  const left =\n    windowFeatures.left ?? Math.max(0, (dimensions.width - width) * 0.5);\n\n  // Create a reasonable popup\n  // https://developer.mozilla.org/en-US/docs/Web/API/Window/open#Window_features\n  return featureObjectToString({\n    ...windowFeatures,\n    // Toolbar buttons (Back, Forward, Reload, Stop buttons).\n    toolbar: windowFeatures.toolbar ?? 'no',\n    menubar: windowFeatures.menubar ?? 'no',\n    // Shows the location bar or the address bar.\n    location: windowFeatures.location ?? 'yes',\n    resizable: windowFeatures.resizable ?? 'yes',\n    // If this feature is on, then the new secondary window has a status bar.\n    status: windowFeatures.status ?? 'no',\n    scrollbars: windowFeatures.scrollbars ?? 'yes',\n    top,\n    left,\n    width,\n    height,\n  });\n}\n\nexport function featureObjectToString(features: Record<string, any>): string {\n  return Object.keys(features).reduce<string>((prev, current) => {\n    let value = features[current];\n    if (typeof value === 'boolean') {\n      value = value ? 'yes' : 'no';\n    }\n    if (current && value) {\n      if (prev) prev += ',';\n      return `${prev}${current}=${value}`;\n    }\n    return prev;\n  }, '');\n}\n"]}